<html>
  <head>
    <title>Mutual Fund Tracker</title>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
    <meta content="utf-8" http-equiv="encoding" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="./public/css/bootstrap-datepicker.min.css" />
    <!-- Load c3.css -->
    <link href="./public/css/c3.min.css" rel="stylesheet" />
    <link
      href="http://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css"
      rel="Stylesheet"
    />

    <!-- Load d3.js and c3.js -->
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="./public/js/c3.min.js"></script>
    <script
      src="https://code.jquery.com/jquery-3.5.1.min.js"
      integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
      crossorigin="anonymous"
    ></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>
    <script src="./public/js/bootstrap-datepicker.min.js"></script>
    <style>
      .invisible {
        display: none;
      }
      .visible {
        display: block;
      }
      .profit {
        color: green;
      }
      .loss {
        color: red;
      }
      body .ui-autocomplete {
        /* font-family to all */
        background-color: white;
        color: black;
      }

      body .ui-autocomplete .ui-menu-item .ui-corner-all {
        /* all <a> */
        background-color: white;
        color: black;
      }

      body .ui-autocomplete .ui-menu-item .ui-state-focus {
        /* selected <a> */
        background-color: white;
        color: black;
      }
    </style>
  </head>
  <body style="background-color: black">
    <div class="container">
      <div class="row" style="overflow-x: auto">
        <table
          class="table table-striped table-dark"
          style="width: 1500px; max-width: 1500px"
        >
          <thead class="">
            <th>Mutual Fund</th>
            <th>Start Date</th>
            <th>Investment</th>
            <th>Cycle</th>
            <th>Units</th>
            <th>Increment</th>
          </thead>
          <tbody id="tBody"></tbody>
        </table>
      </div>
      <div class="row">
        <button class="btn btn-dark col-sm-6" id="addRowBtn">Add Row</button>
        <button class="btn btn-dark col-sm-6" id="showGraphBtn">
          Show Graph
        </button>
      </div>
      <div class="row">
        <video
          id="loadingGif"
          style="width: 120px; height: 120px; padding: 20px; margin: auto"
          class="invisible"
          alt="lefler animation 3d loop glow GIF"
          src="./public/anim/loading.mp4"
          autoplay=""
          loop=""
          playsinline=""
        ></video>
      </div>
      <div class="row invisible" id="chartSection">
        <div id="chart" style="background-color: whitesmoke"></div>
        <div class="row">
          <h1
            id="investedValue"
            class="col-sm-4"
            style="color: whitesmoke"
          ></h1>
          <h1 id="currentValue" class="col-sm-4" style="color: whitesmoke"></h1>
          <h1 id="PnL" class="col-sm-4"></h1>
        </div>
      </div>
    </div>
    <script>
      const ISINURL =
        "https://nsdl.co.in/downloadables/html/hold-mutual-fund-units.html";

      const MILLISECONDS_IN_A_DAY = 24 * 3600 * 1000;
      const YEARS = MILLISECONDS_IN_A_DAY * 365;

      const ISINMAP = {},
        NAMEMAP = {};
      fetch(ISINURL, { mode: "cors" })
        .then((z) => z.text())
        .then((text) => {
          var tempDom = $("<output>").append($.parseHTML(text));

          const doms = $("tr", tempDom);

          for (const it in doms) {
            const row = doms[it];
            // console.log(row);
            if (row.children && row.children.length == 3) {
              const isin = row.children[1].innerText;
              const name = row.children[2].innerText;
              ISINMAP[name] = isin;
              NAMEMAP[isin] = name;
            }
          }
        });

      $(".datepicker").datepicker({});

      let rowCount = 0;

      const getDuration = (startDate) => {
        const diff =
          new Date().getFullYear() - new Date(startDate).getFullYear() + 1;
        return (diff > 5 ? 5 : diff) + "Y";
      };

      const showGraph = async () => {
        startLoadingGif();

        const mf = [];

        const navUrl = [];

        for (let i = 0; i < rowCount; i++) {
          const name = $(`#name_${i + 1}`).val();
          const isin = $(`#isin_${i + 1}`).val();
          const startDate = $(`#startdate_${i + 1}`).val();
          const sip = $(`#sip_${i + 1}`).val();
          const cycle = $(`#cycle_${i + 1}`).val();
          const units = $(`#units_${i + 1}`).val();
          const increment = $(`#increment_${i + 1}`).val();
          if (!isin || !name) {
            continue;
          }

          const duration = getDuration(startDate);
          mf.push({ name, isin, startDate, sip, cycle, units, increment });

          navUrl.push(
            fetch(
              `https://www.moneycontrol.com/mc/widget/mfnavonetimeinvestment/get_chart_value?isin=${isin}&dur=${duration}&ind_id=26&classic=true&type=benchmark&investmentType=Equity`
            )
              .then((z) => z.json())
              .then((z) => z.g1)
          );
        }

        window.localStorage.setItem("DATA", JSON.stringify(mf));

        if (mf.length == 0) {
          stopLoadingGif();
          return;
        }

        const investments = await Promise.all(navUrl).then((navs) => {
          const data = {};
          for (let i = 0; i < navs.length; i++) {
            data[mf[i].isin] = buildInvestmentData(
              navs[i],
              mf[i].sip,
              mf[i].startDate,
              mf[i].cycle,
              mf[i].units,
              mf[i].increment
            );
          }

          const investments = {};
          for (const key in data) {
            for (const { date, invested, value } of data[key]) {
              if (!investments[date]) {
                investments[date] = { invested: 0, value: 0 };
              }
              investments[date].value += value;
              investments[date].invested += invested;
            }
          }

          return investments;
        });

        const keys = Object.keys(investments);
        keys.sort();
        const lastDate = keys[keys.length - 1];
        const diff =
          investments[lastDate].value - investments[lastDate].invested;

        const pl = Math.round(diff * 100) / 100,
          plPercent =
            Math.round((pl * 10000) / investments[lastDate].invested) / 100;

        $("#investedValue").text(
          `Rs. ${Math.round(investments[lastDate].invested * 100) / 100}`
        );
        $("#currentValue").text(
          `Rs. ${Math.round(investments[lastDate].value * 100) / 100}`
        );
        $("#PnL").text(`Rs. ${pl} (${plPercent}%)`);

        $("#PnL").addClass(diff > 0 ? "profit" : "loss");

        const dates = ["x", ...Object.keys(investments)],
          currentValue = [
            "current",
            ...Object.values(investments).map(
              (z) => Math.round(z.value * 100) / 100
            ),
          ],
          invested = [
            "invested",
            ...Object.values(investments).map((z) => z.invested),
          ];

        var chart = c3.generate({
          bindto: "#chart",
          padding: {
            top: 30,
            right: 30,
            bottom: 30,
          },
          data: {
            x: "x",
            columns: [dates, currentValue, invested],
          },
          axis: {
            x: {
              type: "timeseries",
              tick: {
                format: "%Y-%m-%d",
              },
            },
          },
        });

        stopLoadingGif();
      };

      const startLoadingGif = () => {
        $("#loadingGif").removeClass("invisible");
        $("#loadingGif").addClass("visible");
        $("#chartSection").removeClass("visible");
        $("#chartSection").addClass("invisible");
      };

      const stopLoadingGif = () => {
        $("#loadingGif").removeClass("visible");
        $("#loadingGif").addClass("invisible");
        $("#chartSection").removeClass("invisible");
        $("#chartSection").addClass("visible");
      };

      const computeCycleDuration = {
        Weekly: MILLISECONDS_IN_A_DAY * 7,
        Monthly: MILLISECONDS_IN_A_DAY * 30,
        Quarterly: MILLISECONDS_IN_A_DAY * 120,
        Yearly: MILLISECONDS_IN_A_DAY * 365,
        Once: MILLISECONDS_IN_A_DAY * Infinity,
      };

      const buildInvestmentData = function (
        navHistory,
        sip,
        startDate,
        cycle,
        units,
        increment
      ) {
        if (!Array.isArray(navHistory)) {
          return [];
        }

        let total = 0,
          invested = 0;
        const result = [];
        let nextInstallmentDate = Date.parse(startDate);
        for (const { navDate, navValueAdjusted } of navHistory) {
          const temp = Date.parse(navDate);
          if (temp >= nextInstallmentDate) {
            invested += +sip;
            total += sip / navValueAdjusted;
            nextInstallmentDate += computeCycleDuration[cycle];
            if (new Date(navDate).getMonth() == 0) {
              sip = +sip * +(1 + +increment);
            }
          }

          result.push({
            date: navDate,
            invested,
            value: navValueAdjusted * total,
          });
        }

        // if (total == 0 && units == 0) {
        //   continue;
        // } else if (total == 0 && cycle == "Once") {
        //   total = +units;
        //   invested = +sip;
        // }

        return result;
      };

      $("#addRowBtn").on("click", () => {
        rowCount++;

        const html = `<tr><td><input id="name_${rowCount}" class="form-control" style="background-color: black; color: whitesmoke" /></td><td class="invisible"><input id="isin_${rowCount}" class="form-control" style="background-color: black; color: whitesmoke" /></td><td><input id="startdate_${rowCount}" class="form-control datepicker" style="background-color: black; color: whitesmoke" /><span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span></td><td><input id="sip_${rowCount}" type="number" class="form-control" style="background-color: black; color: whitesmoke" /></td><td><select id="cycle_${rowCount}" class="form-control" style="background-color: black; color: whitesmoke" ><option value="Weekly">Weekly</option><option value="Monthly" selected>Monthly</option><option value="Quarterly">Quarterly</option><option value="Yearly">Yearly</option><option value="Once">One Time</option></select></td><td><input id="units_${rowCount}" type="number" class="form-control" style="background-color: black; color: whitesmoke" value="" /></td><td><input id="increment_${rowCount}" type="number" step="0.1" class="form-control" style="background-color: black; color: whitesmoke" value="0" /></td></tr>`;

        $("#tBody").append(html);
        $(".datepicker").datepicker({});
        $(`#name_${rowCount}`).autocomplete({
          source: Object.keys(ISINMAP),
          minLength: 3,
          delay: 1000,
        });
        $(`#name_${rowCount}`).focusout(() => {
          const name = $(`#name_${rowCount}`).val();
          if (name) {
            const isin = ISINMAP[name];
            $(`#isin_${rowCount}`).val(isin);
          } else {
            $(`#isin_${rowCount}`).val("");
          }
        });
      });

      $("#showGraphBtn").on("click", showGraph);

      $(document).ready(() => {
        let data = JSON.parse(window.localStorage.getItem("DATA") || []);

        for (const d of data) {
          rowCount++;

          const html = `<tr><td><input value="${
            d.name
          }" id="name_${rowCount}" class="form-control" style="background-color: black; color: whitesmoke" /></td><td class="invisible"><input value="${
            d.isin
          }" id="isin_${rowCount}" class="form-control" style="background-color: black; color: whitesmoke" /></td><td><input value="${
            d.startDate
          }" id="startdate_${rowCount}" class="form-control datepicker" style="background-color: black; color: whitesmoke" /><span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span></td><td><input value="${
            d.sip
          }" id="sip_${rowCount}" type="number" class="form-control" style="background-color: black; color: whitesmoke" /></td><td><select value="${
            d.cycle
          }" id="cycle_${rowCount}" class="form-control" style="background-color: black; color: whitesmoke" ><option ${
            d.cycle == "Weekly" ? "selected" : ""
          } value="Weekly">Weekly</option><option ${
            d.cycle == "Monthly" ? "selected" : ""
          } value="Monthly">Monthly</option><option ${
            d.cycle == "Quarterly" ? "selected" : ""
          } value="Quarterly">Quarterly</option><option ${
            d.cycle == "Yearly" ? "selected" : ""
          } value="Yearly">Yearly</option><option ${
            d.cycle == "Once" ? "selected" : ""
          } value="Once">One Time</option></select></td><td><input value="${
            d.units
          }" id="units_${rowCount}" type="number" class="form-control" style="background-color: black; color: whitesmoke" /></td><td><input value="${
            d.increment
          }" id="increment_${rowCount}" type="number" step="0.1" class="form-control" style="background-color: black; color: whitesmoke" /></td></tr>`;
          $("#tBody").append(html);
          $(".datepicker").datepicker({});
          $(`#name_${rowCount}`).autocomplete({
            source: Object.keys(ISINMAP),
            minLength: 3,
            delay: 1000,
          });
          $(`#name_${rowCount}`).focusout(() => {
            const name = $(`#name_${rowCount}`).val();
            if (name) {
              const isin = ISINMAP[name];
              $(`#isin_${rowCount}`).val(isin);
            } else {
              $(`#isin_${rowCount}`).val("");
            }
          });
        }

        if (rowCount > 0) {
          showGraph();
        }
      });
    </script>
  </body>
</html>
